rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // USERS COLLECTION
    // Users can only read/write their own profile
    // ============================================
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ============================================
    // DOCUMENTS COLLECTION
    // Users can only access documents they own
    // Supports both 'userId' (legacy) and 'user_id' (new) field names
    // ============================================
    match /documents/{docId} {
      // Read/Update/Delete: Check existing document ownership
      allow read, update, delete: if request.auth != null && 
        (resource.data.userId == request.auth.uid || resource.data.user_id == request.auth.uid);
      
      // Create: Check incoming document ownership
      allow create: if request.auth != null && 
        (request.resource.data.userId == request.auth.uid || request.resource.data.user_id == request.auth.uid);
    }
    
    // ============================================
    // DOCUMENT_CONTENTS COLLECTION
    // Access controlled via parent document ownership lookup
    // The docId here matches the docId in the 'documents' collection
    // ============================================
    match /document_contents/{docId} {
      // Helper function to check if user owns the parent document
      function ownsParentDocument() {
        let parentDoc = get(/databases/$(database)/documents/documents/$(docId)).data;
        return parentDoc.userId == request.auth.uid || parentDoc.user_id == request.auth.uid;
      }
      
      allow read, write: if request.auth != null && ownsParentDocument();
    }
    
    // ============================================
    // FEEDBACK_REPORTS COLLECTION
    // Users can create their own feedback
    // Users can read their own feedback
    // Admins (via custom claims) can read all feedback
    // ============================================
    match /feedback_reports/{reportId} {
      // Create: User must set their own user_id
      allow create: if request.auth != null && 
        request.resource.data.user_id == request.auth.uid;
      
      // Read: User can read their own, or admin can read all
      allow read: if request.auth != null && 
        (resource.data.user_id == request.auth.uid || request.auth.token.admin == true);
      
      // Update/Delete: Only admins (for status updates like 'reviewed', 'resolved')
      allow update, delete: if request.auth != null && request.auth.token.admin == true;
    }
    
  }
}
